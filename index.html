<!DOCTYPE html>
<html lang="de">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>üè† WG Quest</title>

<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<style>
body {
  margin: 0;
  font-family: -apple-system, system-ui, sans-serif;
  background: #f4f6f8;
}
header {
  background: linear-gradient(135deg, #4facfe, #00f2fe);
  color: white;
  padding: 16px;
  text-align: center;
}
select {
  padding: 6px;
  border-radius: 8px;
}
.tabs {
  display: flex;
  background: white;
}
.tabs button {
  flex: 1;
  padding: 12px;
  border: none;
  background: none;
  font-weight: bold;
}
.tabs button.active {
  border-bottom: 3px solid #4facfe;
}
section { display: none; padding: 16px; }
section.active { display: block; }

.task {
  background: white;
  border-radius: 14px;
  padding: 12px;
  margin-bottom: 12px;
  box-shadow: 0 4px 10px rgba(0,0,0,0.08);
  display: flex;
  justify-content: space-between;
  align-items: center;
}
.task small { opacity: 0.7; }

button.done { background: #2ecc71; color: white; border-radius: 8px; border: none; padding: 6px 10px; }
button.undo { background: #bdc3c7; border-radius: 8px; border: none; padding: 6px 10px; }

</style>
</head>

<body>

<header>
  <h1>üè† WG Quest</h1>
  <div>
    Aktiver Spieler:
    <select id="userSelect" onchange="setUser()">
      <option>Maria</option>
      <option>Valentin</option>
    </select>
  </div>
  <div id="xpDisplay">Level 1 ‚Äì 0 XP</div>
</header>

<div class="tabs">
  <button onclick="showTab('tasks')" class="active">üßπ Aufgaben</button>
  <button onclick="showTab('stats')">üìä Statistik</button>
</div>

<section id="tasks" class="active"></section>
<section id="stats">
  <canvas id="chart"></canvas>
</section>

<script>
// üî• FIREBASE
firebase.initializeApp({
  apiKey: "AIzaSyCRfZuJ-DQpmB-TEa7h2S_PHhal6JBy4KI",
  authDomain: "wg-quest.firebaseapp.com",
  projectId: "wg-quest",
  storageBucket: "wg-quest.firebasestorage.app",
  messagingSenderId: "171906625585",
  appId: "1:171906625585:web:d7c618e3d7b70e72a2a510"
});
const db = firebase.database();

// üë§ USER
let currentUser = "Maria";
function setUser() {
  currentUser = document.getElementById("userSelect").value;
  loadXP();
}

// üéÆ XP
function levelFromXP(xp) {
  return Math.floor(xp / 300) + 1;
}

// ‚è±Ô∏è TIME
function daysSince(ts) {
  return Math.floor((Date.now() - ts) / 86400000);
}
function color(days, max) {
  const r = Math.min(days / max, 1);
  return `rgba(${231*r}, ${204*(1-r)}, ${71*(1-r)}, 0.3)`;
}

// üìã TASKS
const tasks = [
  {name:"Sp√ºlmaschine einr√§umen",emoji:"üçΩÔ∏è",freq:"daily",cool:1,xp:10},
  {name:"Sp√ºlmaschine ausr√§umen",emoji:"ü•Ñ",freq:"daily",cool:1,xp:10},
  {name:"Aufr√§umen",emoji:"üßπ",freq:"daily",cool:1,xp:10},

  {name:"M√ºll rausbringen",emoji:"üóëÔ∏è",freq:"weekly",cool:7,xp:30},
  {name:"W√§sche aufh√§ngen",emoji:"üëï",freq:"weekly",cool:7,xp:30},
  {name:"W√§sche abh√§ngen",emoji:"üß∫",freq:"weekly",cool:7,xp:30},
  {name:"Bad putzen",emoji:"üöø",freq:"weekly",cool:7,xp:30},

  {name:"Pfand wegbringen",emoji:"‚ôªÔ∏è",freq:"monthly",cool:30,xp:80},
  {name:"Deep Clean",emoji:"üß®",freq:"monthly",cool:30,xp:80}
];

// ‚úîÔ∏è DONE
function doneTask(task) {
  const now = Date.now();
  db.ref(`history/${task.name}`).set({
    time: now,
    user: currentUser
  });
  db.ref(`xp/${currentUser}`).transaction(v => (v || 0) + task.xp);
}

// ‚Ü©Ô∏è UNDO
function undoTask(task) {
  db.ref(`history/${task.name}`).remove();
  db.ref(`xp/${currentUser}`).transaction(v => (v || 0) - 10);
}

// üîÅ RENDER
function render(snapshot) {
  const data = snapshot.val() || {};
  const history = data.history || {};
  const xp = data.xp || {};

  document.getElementById("xpDisplay").innerText =
    `Level ${levelFromXP(xp[currentUser]||0)} ‚Äì ${xp[currentUser]||0} XP`;

  const container = document.getElementById("tasks");
  container.innerHTML = "";

  ["daily","weekly","monthly"].forEach(freq => {
    container.innerHTML += `<h3>${freq.toUpperCase()}</h3>`;
    tasks.filter(t=>t.freq===freq).forEach(t=>{
      const h = history[t.name];
      const days = h ? daysSince(h.time) : 0;
      container.innerHTML += `
        <div class="task" style="background:${color(days,t.cool)}">
          <div>
            <strong>${t.emoji} ${t.name}</strong>
            <small>${h ? `Zuletzt: ${h.user}, ${days} Tage` : "Noch nie erledigt"}</small>
          </div>
          <div>
            <button class="done" onclick='doneTask(${JSON.stringify(t)})'>‚úî</button>
            <button class="undo" onclick='undoTask(${JSON.stringify(t)})'>‚Ü©</button>
          </div>
        </div>`;
    });
  });

  renderChart(history);
}

// üìä CHART
function renderChart(history){
  const counts = {Maria:0, Valentin:0};
  Object.values(history).forEach(h=>{
    if(h.user) counts[h.user]++;
  });
  if(window.chart) window.chart.destroy();
  window.chart = new Chart(document.getElementById("chart"),{
    type:"pie",
    data:{
      labels:Object.keys(counts),
      datasets:[{data:Object.values(counts)}]
    }
  });
}

// üîå LISTEN
db.ref("/").on("value", render);

// üß≠ TABS
function showTab(id){
  document.querySelectorAll("section").forEach(s=>s.classList.remove("active"));
  document.querySelectorAll(".tabs button").forEach(b=>b.classList.remove("active"));
  document.getElementById(id).classList.add("active");
  event.target.classList.add("active");
}
</script>

</body>
</html>
