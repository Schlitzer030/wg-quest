<!DOCTYPE html>
<html lang="de">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>WG Quest Board üè†</title>

<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<style>
body { font-family: system-ui, sans-serif; background: #f2f2f2; margin:0; padding:0; }
h1 { text-align:center; margin:10px 0; }

.tabs { display:flex; justify-content:space-around; margin:10px 0; }
.tab { flex:1; padding:10px; text-align:center; background:#ddd; cursor:pointer; font-weight:bold; }
.tab.active { background:#bbb; }

#content { padding:10px; }
.task { background:white; padding:12px; margin-bottom:10px; border-radius:12px; box-shadow:0 2px 6px rgba(0,0,0,0.1); display:flex; justify-content: space-between; gap: 10px; flex-wrap:wrap; }
.status { display:inline-block; padding:2px 6px; border-radius:6px; font-size:11px; color:white; margin-top:2px; }
button { border:none; border-radius:8px; padding:6px 10px; margin-top:4px; font-size:13px; color:white; cursor:pointer; }
.maria { background:#e91e63; }
.valentin { background:#3f51b5; }
.undo { background:#9e9e9e; }
.reset-btn { width:100%; padding:8px; margin-bottom:10px; background:#f44336; color:white; border:none; border-radius:8px; font-weight:bold; cursor:pointer; }
canvas { background:white; border-radius:12px; padding:10px; }
</style>
</head>

<body>

<h1>üè† WG Quest</h1>

<div class="tabs">
  <div class="tab active" onclick="showTab('tasksTab')">Aufgaben</div>
  <div class="tab" onclick="showTab('statsTab')">Statistiken</div>
</div>

<div id="content">
  <div id="tasksTab"></div>
  <div id="statsTab" style="display:none">
    <button class="reset-btn" onclick="resetStats()">Statistiken zur√ºcksetzen</button>
    <canvas id="chartStats"></canvas>
  </div>
</div>

<script>
/* üî• Firebase */
firebase.initializeApp({
  apiKey: "AIzaSyCRfZuJ-DQpmB-TEa7h2S_PHhal6JBy4KI",
  authDomain: "wg-quest.firebaseapp.com",
  databaseURL: "https://wg-quest-default-rtdb.europe-west1.firebasedatabase.app",
  projectId: "wg-quest",
  storageBucket: "wg-quest.appspot.com",
  messagingSenderId: "171906625585",
  appId: "1:171906625585:web:d7c618e3d7b70e72a2a510"
});
const db=firebase.database();

/* üßπ Aufgaben kategorisiert nach Frequenz */
const tasks = [
  ["W√§sche aufh√§ngen","üëï",10], ["M√ºll rausbringen","üóëÔ∏è",10], ["Sp√ºlmaschine einr√§umen","üçΩÔ∏è",10], ["Sp√ºlmaschine ausr√§umen","ü•Ñ",10],
  ["Wischen","ü™£",20], ["Staub wischen","üßΩ",20], ["Bad putzen","üöø",20], ["Fenster putzen","ü™ü",20],
  ["Deep Clean","üß®",40], ["K√ºhlschrank auswischen","‚ùÑÔ∏è",40], ["Pfand wegbringen","‚ôªÔ∏è",40], ["Bett beziehen","üõèÔ∏è",40],
  ["Glasm√ºll rausbringen","üçæ",30], ["Waschmaschine reinigen","üßº",30], ["Sp√ºlmaschine reinigen","üßΩ",30], ["K√ºchenablagen wischen","üç≥",30], ["Einkaufen","üõí",20], ["Kochen","üç≤",20], ["Blumen gie√üen","üå∏",10]
].map(t=>({name:t[0],emoji:t[1],points:t[2]||15}));

function days(ts){ if(!ts) return 0; return Math.floor((Date.now()-ts)/(1000*60*60*24)); }
function color(days){ if(days<=1) return "#4caf50"; if(days<=3) return "#8bc34a"; if(days<=6) return "#ffeb3b"; if(days<=9) return "#ff9800"; if(days<=19) return "#f44336"; return "#8b0000"; }
function fmt(ts){ if(!ts) return "noch nie"; const d=new Date(ts); return d.toLocaleDateString("de-DE")+" "+d.toLocaleTimeString("de-DE",{hour:"2-digit",minute:"2-digit"}); }

/* ‚úîÔ∏è Done mit XP & Streak */
function done(task,person){
  const now=Date.now();
  db.ref(`tasks/${task.name}/${person}`).set({ last:now });
  db.ref(`tasks/${task.name}/${person}`).once("value").then(snap=>{
    const data=snap.val();
    const streak = (data?.last && now - data.last < 48*3600000) ? (data.streak||0)+1 : 1;
    db.ref(`tasks/${task.name}/${person}/streak`).set(streak);
    const earned = task.points + streak*2;
    db.ref(`scores/${person}`).transaction(v=>(v||0)+earned);
    db.ref(`scores/WG`).transaction(v=>(v||0)+earned);
    db.ref(`stats/${task.name}/${person}`).transaction(v=>(v||0)+1);
    db.ref(`undo/${task.name}`).set({ person: person, last: now, earned: earned });
  });
}

/* ‚Ü©Ô∏è Undo */
function undo(task){
  db.ref(`undo/${task.name}`).once("value").then(s=>{
    const data=s.val();
    if(data?.person){
      db.ref(`tasks/${task.name}/${data.person}`).set(null);
      db.ref(`scores/${data.person}`).transaction(v=>(v||0)-data.earned);
      db.ref(`scores/WG`).transaction(v=>(v||0)-data.earned);
      db.ref(`stats/${task.name}/${data.person}`).transaction(v=>(v||0)-1);
      db.ref(`undo/${task.name}`).remove();
    }
  });
}

/* üîÑ Render */
let chart;
function render(d){
  tasksTab.innerHTML="";
  tasks.forEach(t=>{
    const m=d.tasks?.[t.name]?.Maria?.last || Date.now();
    const v=d.tasks?.[t.name]?.Valentin?.last || Date.now();
    const lastBy = (!v || (m && m>v)) ? "Maria" : "Valentin";

    const el=document.createElement("div");
    el.className="task";
    el.innerHTML=`
      <div>
        <strong>${t.emoji} ${t.name}</strong> <br>
        Zuletzt erledigt: ${lastBy}<br>
        üë© ${fmt(m)} <span class="status" style="background:${color(days(m))}">vor ${days(m)} Tagen</span><br>
        üë® ${fmt(v)} <span class="status" style="background:${color(days(v))}">vor ${days(v)} Tagen</span>
      </div>
      <div style="min-width:80px;">
        <button class="maria" onclick='done(${JSON.stringify(t)},"Maria")'>Maria ‚úî</button>
        <button class="valentin" onclick='done(${JSON.stringify(t)},"Valentin")'>Valentin ‚úî</button>
        <button class="undo" onclick='undo(${JSON.stringify(t)})'>‚Ü©Ô∏è Zur√ºck</button>
      </div>`;
    tasksTab.appendChild(el);
  });

  /* Statistik als Balkendiagramm */
  const labels = tasks.map(t=>t.name);
  const mariaData = tasks.map(t=>d.stats?.[t.name]?.Maria||0);
  const valentinData = tasks.map(t=>d.stats?.[t.name]?.Valentin||0);

  const ctx = document.getElementById('chartStats').getContext('2d');
  if(chart) chart.destroy();
  chart = new Chart(ctx, {
    type: 'bar',
    data: { labels, datasets:[
      { label:'Maria', data:mariaData, backgroundColor:'#e91e63' },
      { label:'Valentin', data:valentinData, backgroundColor:'#3f51b5' }
    ]},
    options:{ responsive:true, plugins:{legend:{position:'top'}}, scales:{x:{stacked:true}, y:{stacked:true, beginAtZero:true}} }
  });
}

/* Live-Listener */
db.ref("/").on("value",snap=>{
  const d=snap.val()||{};
  render(d);
});

/* Reset Statistik */
function resetStats(){
  if(confirm("Willst du wirklich alle Statistiken zur√ºcksetzen?")){
    db.ref("stats").set(null);
  }
}

/* Tabs */
function showTab(id){
  tasksTab.style.display = (id==="tasksTab") ? "block":"none";
  statsTab.style.display = (id==="statsTab") ? "block":"none";
  document.querySelectorAll(".tab").forEach(t=>t.classList.remove("active"));
  event.currentTarget.classList.add("active");
}

const tasksTab=document.getElementById("tasksTab");
const statsTab=document.getElementById("statsTab");
</script>

</body>
</html>
