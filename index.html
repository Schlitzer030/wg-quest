<!DOCTYPE html>
<html lang="de">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>WG Quest üè†</title>

<!-- Firebase -->
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>

<!-- Chart.js -->
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<style>
body {
  margin:0;
  font-family: system-ui, sans-serif;
  background:#f4f4f4;
}
h1 { text-align:center; margin:12px 0; }

.tabs {
  display:flex;
}
.tab {
  flex:1;
  text-align:center;
  padding:12px;
  font-weight:bold;
  background:#ddd;
}
.tab.active { background:#bbb; }

.section { padding:12px; }

.task {
  background:white;
  padding:12px;
  margin-bottom:10px;
  border-radius:14px;
  box-shadow:0 2px 6px rgba(0,0,0,.1);
}

.task-header {
  display:flex;
  justify-content:space-between;
  align-items:center;
}

.task-meta {
  font-size:12px;
  opacity:.8;
}

.buttons {
  margin-top:8px;
  display:flex;
  gap:6px;
}

button {
  border:none;
  border-radius:8px;
  padding:6px 10px;
  color:white;
}

.maria { background:#e91e63; }
.valentin { background:#3f51b5; }
.undo { background:#9e9e9e; }

.add-box {
  background:white;
  padding:12px;
  border-radius:14px;
  margin-bottom:14px;
}

input, select {
  width:100%;
  padding:6px;
  margin-bottom:6px;
  border-radius:6px;
  border:1px solid #ccc;
}

table {
  width:100%;
  border-collapse:collapse;
  background:white;
  margin-top:20px;
}
th, td {
  padding:6px;
  border-bottom:1px solid #ddd;
  font-size:12px;
  text-align:center;
}
th { background:#eee; }

.reset {
  background:#f44336;
  width:100%;
  padding:10px;
  margin-top:10px;
  border-radius:10px;
}
</style>
</head>

<body>

<h1>üè† WG Quest</h1>

<div class="tabs">
  <div class="tab active" onclick="switchTab('tasks')">Aufgaben</div>
  <div class="tab" onclick="switchTab('stats')">Statistik</div>
</div>

<!-- TASKS -->
<div id="tasks" class="section">
  <div class="add-box">
    <h3>‚ûï Aufgabe hinzuf√ºgen</h3>
    <input id="newName" placeholder="Name">
    <input id="newEmoji" placeholder="Emoji (z.B. üßΩ)">
    <select id="newCat">
      <option value="daily">T√§glich</option>
      <option value="weekly">W√∂chentlich</option>
      <option value="monthly">Monatlich</option>
    </select>
    <button style="background:#4caf50" onclick="addTask()">Hinzuf√ºgen</button>
  </div>
  <div id="taskList"></div>
</div>

<!-- STATS -->
<div id="stats" class="section" style="display:none">
  <canvas id="pieChart" height="260"></canvas>
  <button class="reset" onclick="resetStats()">üîÑ Statistik zur√ºcksetzen</button>
  <table>
    <thead>
      <tr>
        <th>Aufgabe</th>
        <th>Maria</th>
        <th>Valentin</th>
        <th>Gesamt</th>
      </tr>
    </thead>
    <tbody id="statTable"></tbody>
  </table>
</div>

<script>
firebase.initializeApp({
  apiKey: "AIzaSyCRfZuJ-DQpmB-TEa7h2S_PHhal6JBy4KI",
  databaseURL: "https://wg-quest-default-rtdb.europe-west1.firebasedatabase.app"
});
const db = firebase.database();

const defaultTasks = [
  ["Sp√ºlmaschine einr√§umen","üçΩÔ∏è","daily"],
  ["Sp√ºlmaschine ausr√§umen","ü•Ñ","daily"],
  ["M√ºll rausbringen","üóëÔ∏è","daily"],
  ["W√§sche aufh√§ngen","üëï","daily"],
  ["W√§sche abh√§ngen","üß∫","daily"],
  ["K√ºchenablagen wischen","üç≥","daily"],
  ["Kochen","üç≤","daily"],

  ["Staub wischen","üßΩ","weekly"],
  ["Bad putzen","üöø","weekly"],
  ["Boden wischen","ü™£","weekly"],
  ["Fenster putzen","ü™ü","weekly"],
  ["Glasm√ºll rausbringen","üçæ","weekly"],
  ["Einkaufen","üõí","weekly"],
  ["Blumen gie√üen","üå∏","weekly"],
  ["Bett beziehen","üõèÔ∏è","weekly"],

  ["Pfand wegbringen","‚ôªÔ∏è","monthly"],
  ["K√ºhlschrank auswischen","‚ùÑÔ∏è","monthly"],
  ["Deep Clean","üß®","monthly"]
];

db.ref("taskDefs").once("value").then(s=>{
  if(!s.exists()){
    defaultTasks.forEach(t=>{
      db.ref("taskDefs/"+t[0]).set({name:t[0],emoji:t[1],cat:t[2]});
    });
  }
});

function switchTab(tab){
  tasks.style.display = tab==="tasks"?"block":"none";
  stats.style.display = tab==="stats"?"block":"none";
  document.querySelectorAll(".tab").forEach(t=>t.classList.remove("active"));
  event.currentTarget.classList.add("active");
}

function addTask(){
  if(!newName.value) return alert("Name fehlt");
  db.ref("taskDefs/"+newName.value).set({
    name:newName.value,
    emoji:newEmoji.value||"üßπ",
    cat:newCat.value
  });
  newName.value=newEmoji.value="";
}

function markDone(task, person){
  const now=Date.now();
  db.ref("history/"+task.name).set({person,time:now});
  db.ref("stats/"+task.name+"/"+person).transaction(v=>(v||0)+1);
  render();
}

function undo(task){
  db.ref("history/"+task.name).remove();
  render();
}

function render(){
  db.ref("taskDefs").once("value").then(s=>{
    const defs=s.val();
    const list=document.getElementById("taskList");
    list.innerHTML="";
    db.ref("history").once("value").then(h=>{
      const hist=h.val()||{};
      Object.values(defs).forEach(t=>{
        const d=hist[t.name];
        const days=d?Math.floor((Date.now()-d.time)/86400000):0;
        const div=document.createElement("div");
        div.className="task";
        div.innerHTML=`
          <div class="task-header">
            <strong>${t.emoji} ${t.name}</strong>
            <span class="task-meta">${d?`${d.person} ¬∑ vor ${days} Tagen`:"noch nie"}</span>
          </div>
          <div class="buttons">
            <button class="maria" onclick='markDone(${JSON.stringify(t)},"Maria")'>Maria ‚úî</button>
            <button class="valentin" onclick='markDone(${JSON.stringify(t)},"Valentin")'>Valentin ‚úî</button>
            <button class="undo" onclick='undo(${JSON.stringify(t)})'>‚Ü©</button>
          </div>`;
        list.appendChild(div);
      });
    });
  });
  renderStats();
}

let chart;
function renderStats(){
  db.ref("stats").once("value").then(s=>{
    const data=s.val()||{};
    let maria=0,valentin=0;
    statTable.innerHTML="";
    Object.keys(data).forEach(task=>{
      const m=data[task].Maria||0;
      const v=data[task].Valentin||0;
      maria+=m; valentin+=v;
      statTable.innerHTML+=`<tr><td>${task}</td><td>${m}</td><td>${v}</td><td>${m+v}</td></tr>`;
    });
    if(chart) chart.destroy();
    chart=new Chart(pieChart,{
      type:"pie",
      data:{
        labels:["Maria","Valentin"],
        datasets:[{data:[maria,valentin],backgroundColor:["#e91e63","#3f51b5"]}]
      }
    });
  });
}

function resetStats(){
  if(confirm("Statistiken l√∂schen?")){
    db.ref("stats").remove();
  }
}

render();
</script>
</body>
</html>
